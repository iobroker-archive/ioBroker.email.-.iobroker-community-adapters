import{j as o}from"./jsx-runtime-B19fTwGN.js";import{C as r,a as c}from"./ConfigCustomEmailSet__loadShare___mf_0_mui_mf_1_icons_mf_2_material__loadShare__-Difrb-Lc.js";import{C as i}from"./ConfigCustomEmailSet__loadShare___mf_0_iobroker_mf_1_adapter_mf_2_react_mf_2_v5__loadShare__-Lfu7VnRg.js";import{C as l,i as h}from"./ConfigCustomEmailSet__mf_v__runtimeInit__mf_v__-Bd5Kc7oi.js";const{loadShare:_}=h,{initPromise:d}=l,p=d.then(a=>_("@iobroker/json-config",{customShareInfo:{shareConfig:{singleton:!0,strictVersion:!1,requiredVersion:"*"}}})),m=await p.then(a=>a());var u=m;class x extends u.ConfigGeneric{authWindow;async componentDidMount(){super.componentDidMount(),window.addEventListener?window.addEventListener("message",this.onMessage,!1):window.attachEvent("onmessage",this.onMessage,!1),await this.props.oContext.socket.subscribeState(`${this.props.oContext.adapterName}.${this.props.oContext.instance}.microsoftTokens`,this.onTokensUpdated);const t=await this.props.oContext.socket.getState(`${this.props.oContext.adapterName}.${this.props.oContext.instance}.microsoftTokens`);if(t){const e=JSON.parse(t.val);new Date(e.access_token_expires_on).getTime()>Date.now()&&this.setState({accessTokens:t.val})}}onTokensUpdated=(t,e)=>{if(e!=null&&e.val){const s=JSON.parse(e.val);if(new Date(s.access_token_expires_on).getTime()>Date.now()){this.state.accessTokens!==e.val&&this.setState({accessTokens:e.val});return}}this.setState({accessTokens:""})};componentWillUnmount(){super.componentWillUnmount(),window.removeEventListener?window.removeEventListener("message",this.onMessage,!1):window.detachEvent("onmessage",this.onMessage,!1),this.props.oContext.socket.unsubscribeState(`${this.props.oContext.adapterName}.${this.props.oContext.instance}.microsoftTokens`,this.onTokensUpdated)}saveToken(t){try{t&&!t.startsWith("{")&&(t=atob(t));const e=JSON.parse(t);e.access_token&&e.refresh_token&&e.expires_in&&(e.access_token_expires_on||=new Date(Date.now()+e.expires_in*1e3).toISOString(),this.props.oContext.socket.setState(`${this.props.oContext.adapterName}.${this.props.oContext.instance}.microsoftTokens`,JSON.stringify(e),!0).catch(s=>console.log(`Error occurred: ${s}`)))}catch(e){console.log(e)}}onMessage=t=>{var e;if(t.origin==="https://oauth2.iobroker.in"&&(typeof t.data=="string"&&t.data.startsWith("microsoft-authentication:")||typeof t.message=="string"&&t.message.startsWith("microsoft-authentication:"))){const s=(t.data||t.message).split(":");s[1]==="success"?(this.setState({url:"",accessTokens:s[2],success:!0},()=>this.saveToken(this.state.accessTokens)),(e=this.authWindow)==null||e.postMessage("close",t.origin),this.authWindow=null):this.props.onError&&this.props.onError(s[2])}};onOpenUrl(){this.authWindow=window.open(this.state.url,"ioBrokerMicrosoftAuth"),(!this.authWindow||this.authWindow.closed||typeof this.authWindow.closed>"u")&&this.setState({blocked:!0})}renderItem(){let t="";if(this.state.accessTokens)try{const e=JSON.parse(this.state.accessTokens);t=new Date(e.access_token_expires_on).toLocaleString()}catch{}return o.jsxs("div",{style:{width:"100%",margin:"0 0 1rem 0"},children:[o.jsx(r.Button,{disabled:!!this.state.url||!this.props.alive||this.state.running,endIcon:o.jsx(c.CloudUpload,{}),variant:"contained",onClick:()=>this.setState({running:!0},async()=>{const e=await this.props.oContext.socket.sendTo(`${this.props.oContext.adapterName}.${this.props.oContext.instance}`,"authMicrosoft");this.setState({url:e.url,running:!1},()=>this.onOpenUrl())}),children:i.I18n.t(this.state.accessTokens?"Renew Microsoft Access":"Get Microsoft Access")}),this.state.blocked?o.jsx("div",{style:{color:"red",fontSize:16,marginTop:20},children:i.I18n.t("Please allow popups in your browser for this page!")}):null,this.state.accessTokens?o.jsx("div",{style:{color:"green",fontSize:16,marginTop:20},children:this.props.alive?i.I18n.t("Successfully authorized. Token valid till %s and will be automatically renewed.",t):i.I18n.t("Successfully authorized. Token valid till %s but it can expire as the instance is not running.",t)}):null,this.state.url?o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:{width:"100%",margin:"1rem 0 1rem 0"},children:[o.jsx("span",{style:{marginRight:4},children:`${i.I18n.t("Authorize this app by visiting this url:")}`}),o.jsx("br",{}),o.jsx("a",{target:"_blank",href:this.state.url,rel:"noreferrer",children:this.state.url})]}),o.jsx(r.TextField,{value:this.state.accessTokens,label:i.I18n.t("Enter the code from that page here"),variant:"standard",onChange:e=>{let s=e.target.value;s&&!s.startsWith("{")&&(s=atob(s));try{const n=JSON.parse(s);n.access_token&&(n.access_token_expires_on=new Date(Date.now()+(n.expires_in-10)*1e3).toISOString(),this.setState({accessTokens:JSON.stringify(n)},()=>this.saveToken(this.state.accessTokens)))}catch{}},fullWidth:!0})]}):null]})}}export{x as M};
